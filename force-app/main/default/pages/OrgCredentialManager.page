<apex:page controller="OrgCredentialManagerController" showHeader="true" sidebar="false">
    <apex:sectionHeader title="Org Credential Manager" />
    <apex:form id="mainForm">
        
        <apex:pageMessages id="msgPanel" />

        <!-- Existing Credentials Section -->
        <apex:pageBlock title="Retrieve and Update Existing Credential" id="existingBlock">

            <apex:pageBlockSection columns="1">
                <apex:selectList value="{!selectedOrgName}" size="1" label="Select Org" id="orgSelect">
                    <apex:selectOptions value="{!orgOptions}" />
                    <apex:actionSupport event="onchange" action="{!loadSelectedCredential}" 
                                     rerender="existingCredPanel,msgPanel" immediate="false" />
                </apex:selectList>
            </apex:pageBlockSection>

            <apex:outputPanel id="existingCredPanel">
                <apex:pageBlockSection columns="1" rendered="{!hasExistingCredential}">
                    <apex:inputText value="{!existingUsername}" label="Username" />
                    
                    <!-- Password Display Solution -->
                    <apex:outputPanel layout="block" styleClass="passwordContainer">
                        <apex:inputText id="passwordField" value="{!existingPassword}" 
                                       styleClass="passwordInput" 
                                       style="display:none;" />
                        <input type="password" id="passwordDisplay" 
                               value="{!decryptedPasswordForDisplay}" 
                               class="passwordDisplay" 
                               onfocus="this.type='text';" 
                               onblur="this.type='password';"
                               readonly="readonly" />
                        <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            var realInput = document.getElementById('{!$Component.passwordField}');
                            var displayInput = document.getElementById('passwordDisplay');
                            
                            // Sync values between fields
                            displayInput.addEventListener('input', function() {
                                realInput.value = this.value;
                            });
                            
                            // Initialize value
                            if(realInput && displayInput) {
                                displayInput.value = realInput.value;
                            }
                        });
                        </script>
                        <style>
                        .passwordDisplay {
                            width: 200px;
                            height: 22px;
                        }
                        </style>
                    </apex:outputPanel>
                    
                    <apex:commandButton value="Update Credential" action="{!saveExistingCredential}" 
                                       rerender="existingCredPanel,msgPanel" />
                </apex:pageBlockSection>

                <apex:pageBlockSection columns="1" rendered="{!NOT(hasExistingCredential) && NOT(ISBLANK(selectedOrgName))}">
                    <p>No credential found for selected Org.</p>
                </apex:pageBlockSection>
            </apex:outputPanel>
        </apex:pageBlock>

        <!-- New Credential Section -->
        <apex:pageBlock title="Create New Credential">
            <apex:pageBlockSection columns="1">
                <apex:inputText value="{!newOrgName}" label="Org Name" />
                <apex:inputText value="{!newUsername}" label="Username" />
                <apex:inputSecret value="{!newPassword}" label="Password" />
                <apex:commandButton value="Create Credential" action="{!createNewCredential}" 
                                   rerender="msgPanel,orgSelect,existingBlock" />
            </apex:pageBlockSection>
        </apex:pageBlock>

    </apex:form>
</apex:page>