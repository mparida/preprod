<apex:page controller="OrgCredentialManagerController" showHeader="true" sidebar="false">
    <apex:sectionHeader title="Org Credential Manager" />
    <apex:form id="mainForm">

        <apex:pageMessages id="msgPanel" />

        <!-- Existing Credentials Section -->
        <apex:pageBlock title="Retrieve and Update Existing Credential" id="existingBlock">

            <apex:pageBlockSection columns="1">
                <apex:selectList value="{!selectedOrgName}" size="1" label="Select Org" id="orgSelect">
                    <apex:selectOptions value="{!orgOptions}" />
                    <apex:actionSupport event="onchange" action="{!loadSelectedCredential}"
                                        rerender="existingCredPanel,msgPanel" immediate="false" />
                </apex:selectList>
            </apex:pageBlockSection>

            <apex:outputPanel id="existingCredPanel">
                <apex:pageBlockSection columns="1" rendered="{!hasExistingCredential}">
                    <apex:inputText value="{!existingUsername}" label="Username"
                                    onchange="syncPasswordField();"/>

                    <!-- Password Field Solution -->
                    <apex:outputPanel layout="block" styleClass="passwordContainer">
                        <apex:inputSecret id="realPasswordField" value="{!existingPassword}"
                                          style="display:none;"/>

                        <input type="password" id="passwordDisplay"
                               value="{!passwordDisplay}"
                               class="passwordDisplay"
                               onfocus="this.type='text';"
                               onblur="this.type='password';"
                               oninput="document.getElementById('{!$Component.realPasswordField}').value=this.value;"/>

                        <script>
                            // New function to ensure password sync
                            function syncPasswordField() {
                                var displayField = document.getElementById('passwordDisplay');
                                var realField = document.getElementById('{!$Component.realPasswordField}');
                                if(displayField && realField) {
                                    // Ensure Visualforce has current password value
                                    realField.value = displayField.value;
                                }
                            }

                            // Initialize on page load
                            document.addEventListener('DOMContentLoaded', function() {
                                syncPasswordField();
                            });
                        </script>
                    </apex:outputPanel>

                    <apex:commandButton value="Update Credential" action="{!saveExistingCredential}"
                                        rerender="existingCredPanel,msgPanel"
                                        oncomplete="syncPasswordField();"/>
                </apex:pageBlockSection>
            </apex:outputPanel>
        </apex:pageBlock>

        <!-- New Credential Section (unchanged) -->
        <apex:pageBlock title="Create New Credential">
            <apex:pageBlockSection columns="1">
                <apex:inputText value="{!newOrgName}" label="Org Name" />
                <apex:inputText value="{!newUsername}" label="Username" />
                <apex:inputSecret value="{!newPassword}" label="Password" />
                <apex:commandButton value="Create Credential" action="{!createNewCredential}"
                                    rerender="msgPanel,orgSelect,existingBlock" />
            </apex:pageBlockSection>
        </apex:pageBlock>

    </apex:form>
</apex:page>