<apex:page controller="OrgCredentialManagerController" showHeader="false" sidebar="false">
    <script>
        // New function to ensure password sync
        function syncPasswordField() {
            var displayField = document.getElementById('passwordDisplay');
            var realField = document.getElementById('{!$Component.realPasswordField}');
            if(displayField && realField) {
                // Ensure Visualforce has current password value
                realField.value = displayField.value;
            }
        }
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            syncPasswordField();
        });

        function clearNewCredFields() {
            // Only clear if there were no error messages
            if(document.querySelector('.message.error') === null) {
                document.getElementById('{!$Component.newOrgNameInput}').value = '';
                document.getElementById('{!$Component.newUsernameInput}').value = '';
                document.getElementById('{!$Component.newPasswordInput}').value = '';
            }
        }
    </script>
    <apex:sectionHeader title="Org Credential Manager" />
    <apex:form id="mainForm">

        <apex:pageMessages id="msgPanel" />

        <!-- Existing Credentials Section -->
        <apex:pageBlock title="Retrieve and Update Existing Credential" id="existingBlock">

            <apex:pageBlockSection columns="1">
                <apex:selectList value="{!selectedOrgName}" size="1" label="Select Org" id="orgSelect">
                    <apex:selectOptions value="{!orgOptions}" />
                    <apex:actionSupport event="onchange" action="{!loadSelectedCredential}"
                                        rerender="existingCredPanel,msgPanel" immediate="false" />
                </apex:selectList>
            </apex:pageBlockSection>

            <apex:outputPanel id="existingCredPanel">
                <apex:pageBlockSection columns="1" rendered="{!hasExistingCredential}">
                    <!-- Username Field -->
                    <apex:pageBlockSectionItem>
                        <apex:outputLabel value="Username" for="usernameField"/>
                        <apex:inputText id="usernameField" value="{!existingUsername}" style="width:200px"/>
                    </apex:pageBlockSectionItem>

                    <!-- Password Field -->
                    <apex:pageBlockSectionItem>
                        <apex:outputLabel value="Password" for="passwordDisplay"/>
                        <apex:outputPanel layout="block" styleClass="passwordContainer">
                            <apex:inputSecret id="realPasswordField" value="{!existingPassword}" style="display:none;"/>
                            <input type="password" id="passwordDisplay"
                                   value="{!passwordDisplay}"
                                   class="passwordInput"
                                   onfocus="this.type='text';"
                                   onblur="this.type='password';"
                                   oninput="document.getElementById('{!$Component.realPasswordField}').value=this.value;"
                                   style="width:200px; height:22px; padding:2px; border:1px solid #ccc;"/>
                        </apex:outputPanel>
                    </apex:pageBlockSectionItem>

                    <!-- Update Button -->
                    <apex:pageBlockSectionItem>
                        <apex:outputLabel value=""/>
                        <apex:commandButton value="Update Credential" action="{!saveExistingCredential}"
                                            rerender="existingCredPanel,msgPanel"
                                            oncomplete="syncPasswordField();"/>
                    </apex:pageBlockSectionItem>
                </apex:pageBlockSection>
            </apex:outputPanel>
        </apex:pageBlock>

        <!-- New Credential Section (unchanged) -->
        <apex:pageBlock title="Create New Credential" id="newCredBlock">
            <apex:pageBlockSection columns="1">
                <apex:inputText value="{!newOrgName}" label="Org Name" id="newOrgNameInput"/>
                <apex:inputText value="{!newUsername}" label="Username" id="newUsernameInput"/>
                <apex:inputSecret value="{!newPassword}" label="Password" id="newPasswordInput"/>
                <apex:commandButton value="Create Credential" action="{!createNewCredential}"
                                    rerender="msgPanel,orgSelect,existingBlock,newCredBlock"
                                    oncomplete="clearNewCredFields();"/>
            </apex:pageBlockSection>
        </apex:pageBlock>

    </apex:form>
</apex:page>