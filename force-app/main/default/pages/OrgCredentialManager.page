<apex:page controller="OrgCredentialManagerController" showHeader="true" sidebar="false">
    <apex:sectionHeader title="Org Credential Manager" />
    <apex:form id="mainForm">

        <apex:pageMessages id="msgPanel" />

        <!-- Existing Credentials Section -->
        <apex:pageBlock title="Retrieve and Update Existing Credential" id="existingBlock">

            <apex:pageBlockSection columns="1">
                <apex:selectList value="{!selectedOrgName}" size="1" label="Select Org" id="orgSelect">
                    <apex:selectOptions value="{!orgOptions}" />
                    <apex:actionSupport event="onchange" action="{!loadSelectedCredential}"
                                        rerender="existingCredPanel,msgPanel" immediate="false" />
                </apex:selectList>
            </apex:pageBlockSection>

            <apex:outputPanel id="existingCredPanel">
                <apex:pageBlockSection columns="1" rendered="{!hasExistingCredential}">
                    <apex:inputText value="{!existingUsername}" label="Username" />

                    <!-- WORKING PASSWORD FIELD SOLUTION -->
                    <apex:outputPanel layout="block" styleClass="passwordContainer">
                        <!-- Hidden Visualforce field that maintains the actual value -->
                        <apex:inputSecret id="realPasswordField" value="{!existingPassword}"
                                          style="display:none;"/>

                        <!-- Visible/Editable field -->
                        <input type="password" id="passwordDisplay"
                               value="{!passwordDisplay}"
                               class="passwordDisplay"
                               onfocus="this.type='text';"
                               onblur="this.type='password';"
                               oninput="document.getElementById('{!$Component.realPasswordField}').value=this.value;"
                               style="width:200px; height:22px; padding:2px; border:1px solid #ccc;"/>

                        <script>
                            // Initialize password display after rerender
                            function initPasswordField() {
                                var realField = document.getElementById('{!$Component.realPasswordField}');
                                var displayField = document.getElementById('passwordDisplay');
                                if(realField && displayField) {
                                    // Only initialize if display field is empty
                                    if(!displayField.value && realField.value) {
                                        displayField.value = realField.value;
                                    }
                                }
                            }

                            // Call initialization after page load and after every rerender
                            document.addEventListener('DOMContentLoaded', initPasswordField);
                        </script>
                    </apex:outputPanel>

                    <apex:commandButton value="Update Credential" action="{!saveExistingCredential}"
                                        rerender="existingCredPanel,msgPanel"
                                        oncomplete="initPasswordField();"/>
                </apex:pageBlockSection>

                <apex:pageBlockSection columns="1" rendered="{!NOT(hasExistingCredential) && NOT(ISBLANK(selectedOrgName))}">
                    <p>No credential found for selected Org.</p>
                </apex:pageBlockSection>
            </apex:outputPanel>
        </apex:pageBlock>

        <!-- New Credential Section (unchanged) -->
        <apex:pageBlock title="Create New Credential">
            <apex:pageBlockSection columns="1">
                <apex:inputText value="{!newOrgName}" label="Org Name" />
                <apex:inputText value="{!newUsername}" label="Username" />
                <apex:inputSecret value="{!newPassword}" label="Password" />
                <apex:commandButton value="Create Credential" action="{!createNewCredential}"
                                    rerender="msgPanel,orgSelect,existingBlock" />
            </apex:pageBlockSection>
        </apex:pageBlock>

    </apex:form>
</apex:page>